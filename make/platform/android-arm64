# Android NDK ARM64 (arm64-v8a) Platform Configuration
# Requires: Android NDK installed
# Set NDK_ROOT environment variable to NDK path

NDK_ROOT ?= $(ANDROID_NDK_HOME)
NDK_TOOLCHAIN = $(NDK_ROOT)/toolchains/llvm/prebuilt/linux-x86_64
NDK_API = 21

###############################################################################

IDMODULE.suffix = .mp.arm64-v8a.so
STATICLIB.suffix = .a

###############################################################################

DYNLOAD.l  = dl
MATH.l     = m
IPHLPAPI.l =
ADVAPI.l   =

###############################################################################

M4  = m4
TAR = tar
AR  = $(NDK_TOOLCHAIN)/bin/llvm-ar

###############################################################################

CXX = $(NDK_TOOLCHAIN)/bin/aarch64-linux-android$(NDK_API)-clang++

CXX.pch.ext  = gch
CXX.pch.arch = default

CXX.opt.D = $(call fnPrefix,-D,$(CXX.D) $($(CXX.inherit).CXX.D))
CXX.opt.I = $(call fnPrefix,-I,$($(CXX.inherit).CXX.I<) $(CXX.I) $($(CXX.inherit).CXX.I))
CXX.opt.L = $(call fnPrefix,-L,$(CXX.L) $($(CXX.inherit).CXX.L))
CXX.opt.R = $(call fnPrefix,-Xlinker -R,$(CXX.R) $($(CXX.inherit).CXX.R))
CXX.opt.U = $(call fnPrefix,-U,$(CXX.U) $($(CXX.inherit).CXX.U))
CXX.opt.l = $(call fnPrefix,-l,$(CXX.l) $($(CXX.inherit).CXX.l))

CXX.opt.BIT    =
CXX.opt.ML     = -fmessage-length=0
CXX.opt.NSA    = -fno-strict-aliasing
CXX.opt.O      = -O3 -ffast-math
CXX.opt.PIC    = -fPIC
CXX.opt.W      = -w
CXX.opt.g      = -g
CXX.opt.pipe   = -pipe
CXX.opt.p      = -p
CXX.opt.static =
CXX.opt.std    = -fno-exceptions -fno-rtti

CXX.ldopts.exe =
CXX.ldopts.so  = -shared

###############################################################################

CXX.D = ANDROID __ANDROID__
CXX.I = $(BUILD/) $(PROJECT/)src $(PROJECT/)pak
CXX.L = $(BUILD/)
CXX.R =
CXX.U =
CXX.l = log

CXX.BIT    =
CXX.ML     = 1
CXX.NSA    = 1
CXX.O      =
CXX.PIC    = 1
CXX.W      = 1
CXX.g      =
CXX.pipe   = 1
CXX.p      =
CXX.static =
CXX.std    = 1
CXX.vis    =

###############################################################################

CXX.fnStrip =

###############################################################################

CXX.fnCompile = $(call print.COMMAND.normal,$(CXX),$(2),$(strip \
	$(CXX) \
    $(foreach i,pipe W ML BIT std NSA vis PIC O g p,$(foreach j,$(CXX.$(i)),$(CXX.opt.$(i)))) \
	$(CXX.opt.D) \
	$(CXX.opt.I) \
	$(CXX.opt.U) \
	-c $(1) -o $(2) \
	))

CXX.fnCompilePch = $(CXX.fnCompile)

###############################################################################

CXX.fnPrecompile = $(call print.COMMAND.magenta,$(CXX),$(2),$(strip \
	$(CXX) \
    $(foreach i,pipe W ML BIT std NSA vis PIC O g p,$(foreach j,$(CXX.$(i)),$(CXX.opt.$(i)))) \
	$(CXX.opt.D) \
	$(CXX.opt.I) \
	$(CXX.opt.U) \
	-c $(1) -o $(2) \
	))

###############################################################################

CXX.libstdcxx.DEPS =
CXX.libstdcxx.link =

BUILD.output += $(CXX.libstdcxx.DEPS)

###############################################################################

CXX.fnCompileStatic = $(call print.STATIC,$(AR),$(1),$(2),$(AR) cq $(1) $(2))

###############################################################################

CXX.fnLinkExe = $(call print.LINK,$(CXX),$(1),$(3),$(4),$(strip \
    $(CXX) \
    $(foreach i,pipe W ML BIT std NSA vis PIC O g p static,$(foreach j,$(CXX.$(i)),$(CXX.opt.$(i)))) \
    $(CXX.opt.D) \
    $(CXX.opt.I) \
    $(CXX.opt.U) \
    $(CXX.fnLinkExe.<<) $($(CXX.inherit).CXX.fnLinkExe.<<) \
    -o $(1) $(3) $(4) \
    $(CXX.ldopts.exe) \
    $(CXX.opt.R) \
    $(CXX.opt.L) \
    $(CXX.opt.l) \
    $(CXX.fnLinkExe.>>) $($(CC.inherit).CC.fnLinkExe.>>) \
    ))

###############################################################################

CXX.fnLinkSo = $(call print.LINK,$(CXX),$(1),$(2),$(strip \
    $(CXX) \
    $(foreach i,pipe W ML BIT std NSA vis PIC O g p static,$(foreach j,$(CXX.$(i)),$(CXX.opt.$(i)))) \
    $(CXX.opt.D) \
    $(CXX.opt.I) \
    $(CXX.opt.U) \
    $(CXX.fnLinkSo.<<) $($(CXX.inherit).CXX.fnLinkSo.<<) \
    -o $(1) $(2) \
    $(CXX.ldopts.so) \
    $(CXX.opt.R) \
    $(CXX.opt.L) \
    $(CXX.opt.l) \
    $(CXX.fnLinkSo.>>) $($(CC.inherit).CC.fnLinkSo.>>) \
    ))

###############################################################################

SPECIALS.name  = android-arm64
SPECIALS.build = build
SPECIALS.base  = $(PROJECT.packageBase)-$(SPECIALS.name)
SPECIALS.base/ = $(BUILD/)$(SPECIALS.base)/

world:: default debug release
